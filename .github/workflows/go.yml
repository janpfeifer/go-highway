name: Go

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go (bootstrap)
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: false

      - name: Install Go 1.26rc1
        run: |
          go install golang.org/dl/go1.26rc1@latest
          go1.26rc1 download
          echo "GOROOT=$(go1.26rc1 env GOROOT)" >> $GITHUB_ENV
          echo "$(go1.26rc1 env GOROOT)/bin" >> $GITHUB_PATH

      - name: Verify Go version
        run: go version

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ matrix.os }}-go-1.26rc1-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ matrix.os }}-go-1.26rc1-

      - name: Run go vet
        env:
          GOEXPERIMENT: simd
        run: go vet ./...

      - name: Run tests (fallback path)
        run: go test -v -race ./...

      - name: Run tests (SIMD enabled)
        env:
          GOEXPERIMENT: simd
        run: go test -v -race ./...

      - name: Run benchmarks (SIMD enabled)
        env:
          GOEXPERIMENT: simd
        run: go test -bench=. -benchmem -run=^$ ./hwy/contrib/...

      - name: Build examples
        env:
          GOEXPERIMENT: simd
        run: |
          go build -o bin/hwygen ./cmd/hwygen
          go build -o examples/basic/basic ./examples/basic
          go build -o examples/contrib_test/contrib_test ./examples/contrib_test

      - name: Run basic example
        env:
          GOEXPERIMENT: simd
        run: ./examples/basic/basic
