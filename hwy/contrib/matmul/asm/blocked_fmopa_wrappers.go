// Copyright 2025 go-highway Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

//go:build !noasm && arm64

// Blocked/Cache-Tiled SME FMOPA Matrix Multiplication wrappers for ARM64
package asm

import "unsafe"

// Generate assembly from C using goat
// -march=armv9-a+sme+sme-f64f64 enables SME with f32/f64 support
//go:generate go tool goat ../c/blocked_fmopa_arm64.c -O3 --target arm64 --target-os darwin -e="-march=armv9-a+sme+sme-f64f64"

// BlockedMatMulFMOPAF32 performs cache-tiled matrix multiplication using SME FMOPA: C = AT^T * B
// AT is the transposed A matrix (K x M, row-major) for contiguous column access.
// B is K x N (row-major), C is M x N (row-major).
//
// Uses 48×48 cache blocks with 16×16 FMOPA tiles.
// Requires M, N to be multiples of 16.
//
// Parameters:
//   - at: K x M matrix (A transposed, row-major)
//   - b: K x N matrix (row-major)
//   - c: M x N matrix (row-major, output)
//   - m, n, k: matrix dimensions
func BlockedMatMulFMOPAF32(at, b, c []float32, m, n, k int) {
	if m == 0 || n == 0 || k == 0 {
		return
	}
	if len(at) < k*m || len(b) < k*n || len(c) < m*n {
		return
	}
	mVal := int64(m)
	nVal := int64(n)
	kVal := int64(k)
	blockedmatmul_fmopa_at_f32(
		unsafe.Pointer(&at[0]),
		unsafe.Pointer(&b[0]),
		unsafe.Pointer(&c[0]),
		unsafe.Pointer(&mVal),
		unsafe.Pointer(&nVal),
		unsafe.Pointer(&kVal),
	)
}

// BlockedMatMulFMOPAF64 performs cache-tiled matrix multiplication using SME FMOPA: C = AT^T * B
// Same algorithm but with 8×8 tiles for float64.
// Requires M, N to be multiples of 8.
//
// Parameters:
//   - at: K x M matrix (A transposed, row-major)
//   - b: K x N matrix (row-major)
//   - c: M x N matrix (row-major, output)
//   - m, n, k: matrix dimensions
func BlockedMatMulFMOPAF64(at, b, c []float64, m, n, k int) {
	if m == 0 || n == 0 || k == 0 {
		return
	}
	if len(at) < k*m || len(b) < k*n || len(c) < m*n {
		return
	}
	mVal := int64(m)
	nVal := int64(n)
	kVal := int64(k)
	blockedmatmul_fmopa_at_f64(
		unsafe.Pointer(&at[0]),
		unsafe.Pointer(&b[0]),
		unsafe.Pointer(&c[0]),
		unsafe.Pointer(&mVal),
		unsafe.Pointer(&nVal),
		unsafe.Pointer(&kVal),
	)
}

// Assembly function declarations are in blocked_fmopa_arm64.go (generated by GoAT)
