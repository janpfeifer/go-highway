// Code generated by github.com/ajroetker/go-highway/cmd/hwygen. DO NOT EDIT.

//go:build amd64 && goexperiment.simd

package nn

import (
	"simd/archsimd"

	"github.com/ajroetker/go-highway/hwy"
)

var QKVDenseFloat16 func(x []hwy.Float16, wQKV []hwy.Float16, biasQ []hwy.Float16, biasK []hwy.Float16, biasV []hwy.Float16, q []hwy.Float16, k []hwy.Float16, v []hwy.Float16, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVDenseBFloat16 func(x []hwy.BFloat16, wQKV []hwy.BFloat16, biasQ []hwy.BFloat16, biasK []hwy.BFloat16, biasV []hwy.BFloat16, q []hwy.BFloat16, k []hwy.BFloat16, v []hwy.BFloat16, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVDenseFloat32 func(x []float32, wQKV []float32, biasQ []float32, biasK []float32, biasV []float32, q []float32, k []float32, v []float32, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVDenseFloat64 func(x []float64, wQKV []float64, biasQ []float64, biasK []float64, biasV []float64, q []float64, k []float64, v []float64, batchSize int, inFeatures int, qDim int, kvDim int)

// QKVDense computes a fused QKV projection: a single matmul against stacked
// Q/K/V weights, then splits and adds per-segment biases.
//
//   - x:      [batchSize, inFeatures] (row-major)
//   - wQKV:   [(qDim + 2*kvDim), inFeatures] (row-major, stacked Q, K, V weights)
//   - biasQ:  [qDim] (optional, pass nil to skip)
//   - biasK:  [kvDim] (optional, pass nil to skip)
//   - biasV:  [kvDim] (optional, pass nil to skip)
//   - q:      [batchSize, qDim] output
//   - k:      [batchSize, kvDim] output
//   - v:      [batchSize, kvDim] output
//
// This fuses the matmul, scatter, and bias-add into a single pass, avoiding
// a temporary buffer and separate scatter copy. Each output row is computed
// via SIMD dot-product accumulation with 4-row unrolling on batchSize.
//
// This function dispatches to the appropriate SIMD implementation at runtime.
func QKVDense[T hwy.Floats](x []T, wQKV []T, biasQ []T, biasK []T, biasV []T, q []T, k []T, v []T, batchSize int, inFeatures int, qDim int, kvDim int) {
	switch any(x).(type) {
	case []hwy.Float16:
		QKVDenseFloat16(any(x).([]hwy.Float16), any(wQKV).([]hwy.Float16), any(biasQ).([]hwy.Float16), any(biasK).([]hwy.Float16), any(biasV).([]hwy.Float16), any(q).([]hwy.Float16), any(k).([]hwy.Float16), any(v).([]hwy.Float16), batchSize, inFeatures, qDim, kvDim)
	case []hwy.BFloat16:
		QKVDenseBFloat16(any(x).([]hwy.BFloat16), any(wQKV).([]hwy.BFloat16), any(biasQ).([]hwy.BFloat16), any(biasK).([]hwy.BFloat16), any(biasV).([]hwy.BFloat16), any(q).([]hwy.BFloat16), any(k).([]hwy.BFloat16), any(v).([]hwy.BFloat16), batchSize, inFeatures, qDim, kvDim)
	case []float32:
		QKVDenseFloat32(any(x).([]float32), any(wQKV).([]float32), any(biasQ).([]float32), any(biasK).([]float32), any(biasV).([]float32), any(q).([]float32), any(k).([]float32), any(v).([]float32), batchSize, inFeatures, qDim, kvDim)
	case []float64:
		QKVDenseFloat64(any(x).([]float64), any(wQKV).([]float64), any(biasQ).([]float64), any(biasK).([]float64), any(biasV).([]float64), any(q).([]float64), any(k).([]float64), any(v).([]float64), batchSize, inFeatures, qDim, kvDim)
	}
}

func init() {
	if hwy.NoSimdEnv() {
		initQkvdenseFallback()
		return
	}
	if archsimd.X86.AVX512() {
		initQkvdenseAVX512()
		return
	}
	if archsimd.X86.AVX2() {
		initQkvdenseAVX2()
		return
	}
	initQkvdenseFallback()
}

func initQkvdenseAVX2() {
	QKVDenseFloat16 = BaseQKVDense_avx2_Float16
	QKVDenseBFloat16 = BaseQKVDense_avx2_BFloat16
	QKVDenseFloat32 = BaseQKVDense_avx2
	QKVDenseFloat64 = BaseQKVDense_avx2_Float64
}

func initQkvdenseAVX512() {
	QKVDenseFloat16 = BaseQKVDense_avx512_Float16
	QKVDenseBFloat16 = BaseQKVDense_avx512_BFloat16
	QKVDenseFloat32 = BaseQKVDense_avx512
	QKVDenseFloat64 = BaseQKVDense_avx512_Float64
}

func initQkvdenseFallback() {
	QKVDenseFloat16 = BaseQKVDense_fallback_Float16
	QKVDenseBFloat16 = BaseQKVDense_fallback_BFloat16
	QKVDenseFloat32 = BaseQKVDense_fallback
	QKVDenseFloat64 = BaseQKVDense_fallback_Float64
}
