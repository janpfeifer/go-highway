// Code generated by hwygen. DO NOT EDIT.
//go:build amd64 && goexperiment.simd

package varint

import (
	"github.com/ajroetker/go-highway/hwy"
	"simd/archsimd"
)

func BaseDecodeStreamVByte32_avx512(control []byte, data []uint8, n int) []uint32 {
	if n <= 0 || len(control) == 0 {
		return nil
	}
	result := make([]uint32, n)
	BaseDecodeStreamVByte32Into_avx512(control, data, result)
	return result
}

func BaseDecodeStreamVByte32Into_avx512(control []byte, data []uint8, dst []uint32) (decoded int, dataConsumed int) {
	if len(dst) == 0 || len(control) == 0 {
		return 0, 0
	}
	dataPos := 0
	dstPos := 0
	n := len(dst)
	for _, ctrl := range control {
		if dstPos >= n {
			break
		}
		if dstPos+4 <= n && dataPos+16 <= len(data) {
			consumed := BaseDecodeStreamVByte32GroupSIMD_avx512(ctrl, data[dataPos:], dst[dstPos:])
			if consumed > 0 {
				dataPos += consumed
				dstPos += 4
				continue
			}
		}
		for i := 0; i < 4 && dstPos < n; i++ {
			length := int(((ctrl >> (i * 2)) & 0x3) + 1)
			if dataPos+length > len(data) {
				return dstPos, dataPos
			}
			var v uint32
			switch length {
			case 1:
				v = uint32(data[dataPos])
			case 2:
				v = uint32(data[dataPos]) | uint32(data[dataPos+1])<<8
			case 3:
				v = uint32(data[dataPos]) | uint32(data[dataPos+1])<<8 | uint32(data[dataPos+2])<<16
			case 4:
				v = uint32(data[dataPos]) | uint32(data[dataPos+1])<<8 | uint32(data[dataPos+2])<<16 | uint32(data[dataPos+3])<<24
			}
			dst[dstPos] = v
			dstPos++
			dataPos += length
		}
	}
	return dstPos, dataPos
}

func BaseDecodeStreamVByte32GroupSIMD_avx512(ctrl byte, data []uint8, dst []uint32) int {
	dataLen := int(streamVByte32DataLen[ctrl])
	if len(data) < dataLen || len(dst) < 4 {
		return 0
	}
	if len(data) < 16 {
		return decodeGroupScalarInto(ctrl, data, dst)
	}
	dataVec := archsimd.LoadUint8x16Slice(data[:16])
	maskSlice := streamVByte32ShuffleMasks[ctrl][:]
	maskVec := archsimd.LoadUint8x16Slice(maskSlice)
	shuffled := hwy.TableLookupBytes_AVX512_Uint8x16(dataVec, maskVec)
	var result [16]uint8
	shuffled.StoreSlice(result[:])
	dst[0] = uint32(result[0]) | uint32(result[1])<<8 | uint32(result[2])<<16 | uint32(result[3])<<24
	dst[1] = uint32(result[4]) | uint32(result[5])<<8 | uint32(result[6])<<16 | uint32(result[7])<<24
	dst[2] = uint32(result[8]) | uint32(result[9])<<8 | uint32(result[10])<<16 | uint32(result[11])<<24
	dst[3] = uint32(result[12]) | uint32(result[13])<<8 | uint32(result[14])<<16 | uint32(result[15])<<24
	return dataLen
}
